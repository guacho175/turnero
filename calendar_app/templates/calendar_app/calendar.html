<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Agenda</title>

  <!-- FullCalendar CSS -->
  <link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.css"
  />

  <!-- FullCalendar JS -->
  <script
    src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js"
  ></script>

  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      margin: 0;
    }

    h2 {
      text-align: center;
      margin: 16px 0 8px;
    }

    .toolbar {
      max-width: 1100px;
      margin: 0 auto 6px;
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 0 8px;
    }

    .toolbar label {
      font-weight: 600;
    }

    .toolbar select {
      padding: 6px 10px;
      font-size: 14px;
    }

    #statusMsg {
      max-width: 1100px;
      margin: 0 auto 8px;
      padding: 0 8px;
      font-size: 13px;
      color: #444;
    }

    #calendarWrap {
      max-width: none;
      margin: 0 auto 24px;
      padding: 0 8px;
    }

    /* Protecciones mínimas contra CSS global */
    .fc ul, .fc ol {
      list-style: none !important;
      margin: 0 !important;
      padding: 0 !important;
    }

    .fc a {
      text-decoration: none !important;
      color: inherit;
    }

    .fc table {
      border-collapse: collapse !important;
    }


        /* Fondo general de la página */
    body {
      background-color: #f4f8ff; /* azul muy suave */
    }

    /* Contenedor del calendario */
    #calendarWrap {
      background-color: #ffffff;
      border-radius: 10px;
      box-shadow: 0 10px 25px rgba(0, 60, 120, 0.12);
      padding: 16px;
    }

    /* Barra superior del calendario */
    .fc .fc-toolbar {
      background-color: #1e3a8a;   /* azul fuerte */
      color: #ffffff;
      border-radius: 8px;
      padding: 8px 12px;
    }

    /* Título del mes */
    .fc .fc-toolbar-title {
      color: #ffffff;
      font-weight: 600;
    }

    /* Botones */
    .fc .fc-button {
      background-color: #2563eb;  /* azul */
      border: none;
      color: #ffffff;
    }

    .fc .fc-button:hover {
      background-color: #1d4ed8;
    }

    .fc .fc-button:disabled {
      background-color: #93c5fd;
    }

  </style>
</head>

<body>
  <h2>Agenda (Google Calendar)</h2>

  <!-- Selector -->
  <div class="toolbar">
    <label for="agendaSelect">Agenda:</label>
    <select id="agendaSelect">
      {% for agenda in agendas %}
        <option
          value="{{ agenda.key }}"
          {% if agenda.key == default_agenda %}selected{% endif %}
        >
          {{ agenda.key }}
        </option>
      {% endfor %}
    </select>
  </div>

  <!-- Mensaje de estado -->
  <div id="statusMsg"></div>

  <!-- Calendario -->
  <div id="calendarWrap">
    <div id="calendar"></div>
  </div>

  <script>
    const agendaSelect = document.getElementById("agendaSelect");
    const statusMsg = document.getElementById("statusMsg");

    async function fetchEvents(info) {
      const url = new URL(window.location.origin + "/calendar/events");
      url.searchParams.set("agenda", agendaSelect.value);
      url.searchParams.set("time_min", info.startStr);
      url.searchParams.set("time_max", info.endStr);
      url.searchParams.set("max_results", "250");

      const res = await fetch(url.toString(), { cache: "no-store" });
      if (!res.ok) throw new Error("No se pudo cargar eventos");

      const data = await res.json();

      // Mensaje claro para evitar confusión
      if (data.count === 0) {
        statusMsg.textContent =
          `Sin eventos para "${agendaSelect.value}" en este rango. ` +
          `Cambia de mes para ver otros eventos.`;
      } else {
        statusMsg.textContent =
          `Agenda: ${data.agenda} · Eventos en vista: ${data.count}`;
      }

      console.log(
        "[events]",
        data.agenda,
        "count:",
        data.count,
        "range:",
        info.startStr,
        "->",
        info.endStr
      );

      return (data.events || []).map(ev => {
        const start = (ev.start && (ev.start.dateTime || ev.start.date)) || null;
        const end = (ev.end && (ev.end.dateTime || ev.end.date)) || null;

        return {
          id: ev.id,
          title: ev.summary || "(Sin título)",
          start,
          end,
          url: ev.htmlLink || null
        };
      });
    }

    document.addEventListener("DOMContentLoaded", () => {
      const el = document.getElementById("calendar");

      const calendar = new FullCalendar.Calendar(el, {
        initialView: "dayGridMonth",
        height: "auto",
        expandRows: true,
        fixedWeekCount: false,
        dayMaxEvents: true,   // muestra "+X more"
        nowIndicator: true,

        headerToolbar: {
          left: "prev,next today",
          center: "title",
          right: "dayGridMonth,timeGridWeek,timeGridDay"
        },

        events: async (info, successCallback, failureCallback) => {
          try {
            const events = await fetchEvents(info);
            successCallback(events);
          } catch (e) {
            console.error(e);
            statusMsg.textContent = "Error cargando eventos.";
            failureCallback(e);
          }
        }
      });

      agendaSelect.addEventListener("change", () => {
        calendar.refetchEvents();
      });

      calendar.render();
    });
  </script>
</body>
</html>
